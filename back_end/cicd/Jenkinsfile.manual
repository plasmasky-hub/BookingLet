pipeline {
     agent any

     environment {
         AWS_ACCOUNT_ID="988898134629"
         AWS_DEFAULT_REGION="ap-southeast-2" 
 	    CLUSTER_NAME="bookinglet-cluster"
 	    SERVICE_NAME="nodejs-container-service"
 	    TASK_DEFINITION_NAME="first-run-task-definition"
 	    DESIRED_COUNT="1"
         IMAGE_REPO_NAME="988898134629.dkr.ecr.ap-southeast-2.amazonaws.com/bookinglet-docker-test"
         // IMAGE_TAG="${env.BUILD_ID}"
         REPOSITORY_URI = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${IMAGE_REPO_NAME}"
 	    registryCredential = "xinglindevops"
     }

     stages {
         // stage('Git checkout') {
         //     steps {
         //         // Get source code from Austin's Repo
         //         git branch:'S3', url:'https://github.com/xinglinchen666/p3Test.git'
         //     }
         // }

         stage('npm install') {
             steps {
                 dir("./back_end/"){
                 sh 'npm install'
                 }
             }
         }
         // stage('npm run dev'){
         //     steps {
         //         dir("./back_end/"){
         //         sh 'npm run dev'
         //     }
         // }
         // }


         //Buidling Docker Images
         stage('Building back_end image'){
             steps {
                 dir("./back_end/"){
                     sh 'docker build -t demo .'
                 }
             }
         }

         //Uploading Docker Images into AWS ECR
         stage('Pushing to ECR'){
             steps{
                 dir("./back_end/"){   
                     sh 'docker tag demo:latest 988898134629.dkr.ecr.ap-southeast-2.amazonaws.com/demo:latest'
                     sh 'docker push 988898134629.dkr.ecr.ap-southeast-2.amazonaws.com/demo:latest'
                 }
             }
         }   

         stage('Deploy') {
              steps{
                 withAWS(credentials: registryCredential, region: "${AWS_DEFAULT_REGION}") {
                   script {
                     sh 'chmod +x -R /var/lib/jenkins/workspace/bookinglet_backend/back_end/cicd/script.sh'
  		        	sh './back_end/cicd/script.sh'
                     }
              } 
           }
       }      

     }
 }